---
title: "ç¨‹åºçš„æœºå™¨çº§è¡¨ç¤º"
subtitle: "CSAPPè¯»ä¹¦ç¬”è®°ç¬¬3ç« "
date: 2022-05-08T07:27:38+08:00
draft: false
author: "bugxch"
authorLink: "https://www.zhihu.com/people/bug_ahoy"
description: ""

tags: ["CSAPP"]
categories: ["æŠ€è‰º"]

image: "https://pic.imgdb.cn/item/6277012f0947543129b619f5.jpg"
---

ç»§ç»­ä¹‹å‰çš„[CSAPPè¯»ä¹¦ç¬”è®°](https://bugxch.github.io/csapp_notes/)ï¼Œè¿™æ˜¯ç¬¬3ç« çš„è¯»ä¹¦ç¬”è®°ã€‚

<!--more-->

ç¬¬3ç« ä»‹ç»è®¡ç®—æœºçš„åº•å±‚æœºå™¨ç¼–ç ï¼ŒåŒ…æ‹¬å¸¸è§çš„åŸºæœ¬æ•°æ®ã€ä¸ºäº†æ‰§è¡Œæœºå™¨æŒ‡ä»¤è€Œè®¾ç½®çš„å¯„å­˜å™¨ã€ç®—æœ¯å’Œé€»è¾‘æ“ä½œä»¥åŠæ§åˆ¶çš„æŒ‡ä»¤ã€‚3.7èŠ‚è¯¦ç»†ä»‹ç»äº†**è¿‡ç¨‹**çš„æ¦‚å¿µï¼Œæœ€åæ˜¯å…¶ä»–æ•°æ®ç»“æ„åœ¨è®¡ç®—æœºæœºå™¨ä»£ç çš„è¡¨ç¤ºã€‚

## å®éªŒå·¥å…·

è¦æƒ³ç ”ç©¶åº•å±‚æœºå™¨æŒ‡ä»¤ï¼Œæœ€ç›´è§‚çš„å°±æ˜¯æ±‡ç¼–ç¨‹åºï¼Œå‚è€ƒä¹¦æœ¬é‡Œé¢çš„ä»‹ç»ï¼Œä»¥linuxç³»ç»Ÿçš„gccç¨‹åºä¸ºå·¥å…·ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å¾—åˆ°ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ˜¯ä¸€ä¸ª `hello.c`çš„ç¨‹åºä»é«˜çº§è¯­è¨€ç¨‹åºç¼–è¯‘æˆæœºå™¨ä»£ç çš„è¿‡ç¨‹ã€‚

![](https://pic.imgdb.cn/item/6278b71f0947543129c38bee.png)

- ä½¿ç”¨**ç¼–è¯‘å™¨**è¿è¡Œå¦‚ä¸‹å‘½ä»¤

  ```shell
  gcc -Og -S hello.c
  ```
  å¯ä»¥å¾—åˆ° `hello.s`çš„æ±‡ç¼–æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä»…ä»…åŒ…æ‹¬æ±‡ç¼–æŒ‡ä»¤ï¼Œæ²¡æœ‰äºŒè¿›åˆ¶çš„æœºå™¨ç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º

  ![](https://pic.imgdb.cn/item/6278f45e09475431296b2e6b.png)

  ä¸è¿‡å¯¹äº**ç†è§£æœ¬ç« èŠ‚çš„å†…å®¹å·²ç»è¶³å¤Ÿ**ã€‚

- ä½¿ç”¨æ±‡ç¼–å™¨è¿›ä¸€æ­¥å¯ä»¥å°† `hello.s`ç¿»è¯‘æˆæœºå™¨è¯­è¨€æŒ‡ä»¤ï¼Œç§°ä¸º*å¯é‡å®šä½ç›®æ ‡ç¨‹åº*ï¼Œé‡Œé¢å…¨æ˜¯äºŒè¿›åˆ¶ç ï¼Œè¿™ä¸ªå°±æ˜¯åº•å±‚æœºå™¨æŒ‡ä»¤ï¼Œè‚‰çœ¼çœ‹è¿‡å»å°±æ˜¯ä¸€ä¸²äºŒè¿›åˆ¶ç ï¼Œæ ¹æœ¬ä¸çŸ¥é“æ˜¯ä»€ä¹ˆä¸œè¥¿ã€‚å¯ä»¥åŸºäº**åæ±‡ç¼–**çš„æ–¹æ³•å°†è¯¥æ–‡ä»¶åæ±‡ç¼–æˆæ±‡ç¼–çš„ä»£ç ï¼Œ

  ```shell
  gcc -Og -c hello.c #ç”Ÿæˆhello.oæ–‡ä»¶
  objdump -d hello.o #åæ±‡ç¼–æ–‡ä»¶
  ```

  å¾—åˆ°çš„æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤º

  ![](https://pic.imgdb.cn/item/6278f59b09475431296e2a64.png)

  ä¸ä¸Šé¢çš„æ–¹æ³•ç›¸æ¯”ï¼Œé™¤äº†æ±‡ç¼–æŒ‡ä»¤ä¹‹å¤–ï¼Œè¿˜æœ‰è¿™äº›æŒ‡ä»¤çš„äºŒè¿›åˆ¶ç¼–ç ã€‚

## åŸºç¡€æ¦‚å¿µ

### æ•°æ®æ ¼å¼å’ŒæŒ‡ä»¤

è¿™äº›æ˜¯æœ¬ç« çš„ä¸»è¦å†…å®¹ï¼Œä¹Ÿæ˜¯ç†è§£æ±‡ç¼–ä»£ç çš„åŸºç¡€ã€‚å…·ä½“çš„æŠ€æœ¯ç»†èŠ‚ä¹¦æœ¬é‡Œé¢å·²ç»è¯´æ¸…æ¥šäº†ï¼Œæ­¤å¤„ä»…ä»…å¯¹äºéœ€è¦ç‰¹åˆ«æ³¨æ„çš„åœ°æ–¹åšä¸€ä¸ªæ€»ç»“ã€‚

- ISAæŒ‡ä»¤åŒ…æ‹¬16ä¸ªé•¿åº¦æ˜¯64bitçš„å¯„å­˜å™¨ï¼Œè¿™æ˜¯è®¡ç®—æœºè¿è¡Œçš„æ•°æ®ä¿å­˜çš„åœ°æ–¹ã€‚éœ€è¦æ³¨æ„ï¼Œæ¯ä¸ªå¯„å­˜å™¨æœ‰é•¿åº¦ï¼Œå¯ä»¥è¦†ç›–1ã€2ã€4å’Œ8ä¸ªå­—èŠ‚çš„æ‰€æœ‰é•¿åº¦ã€‚

- è®¡ç®—æœºçš„å¯»å€æ–¹å¼æœ‰å¦‚ä¸‹å‡ ç§

  ![](https://pic.imgdb.cn/item/6278f8460947543129747901.png)

- æ•°æ®ä¼ é€æŒ‡ä»¤éœ€è¦æ³¨æ„ä¸‹é¢çš„ç‚¹

  - ä¼ é€çš„æŒ‡ä»¤çš„**ä¸¤ä¸ªæ“ä½œæ•°ä¸èƒ½éƒ½æŒ‡å‘å†…å­˜ä½ç½®**ã€‚å› æ­¤ï¼Œæ²¡æœ‰æŒ‡ä»¤å¯ä»¥ç›´æ¥å°†**å†…å­˜ä¸­çš„ä½ç½®**Aæ¬ç§»åˆ°**å†…å­˜ä¸­çš„ä½ç½®**Bï¼Œå¿…é¡»å…ˆå°†Aæ¬ç§»åˆ°å¯„å­˜å™¨ï¼Œä¹‹åå†ä»å¯„å­˜å™¨æ¬ç§»åˆ°å†…å­˜Bï¼›

  - `movl`è¿™ä¸ªæŒ‡ä»¤æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒæ˜¯ä¼ é€åŒå­—ï¼ˆ4ä¸ªå­—èŠ‚ï¼‰çš„æ•°æ®ï¼Œä½†æ˜¯ä¹Ÿä¼šåŒæ—¶å°†ç›®çš„å¯„å­˜å™¨çš„é«˜4ä¸ªå­—èŠ‚ä¸€å¹¶æ¸…é›¶ã€‚

- æ‰€æœ‰çš„æ±‡ç¼–æŒ‡ä»¤çš„ç«‹å³æ•°éƒ½æ˜¯äºŒè¿›åˆ¶è¡¥ç ç¼–ç çš„ï¼Œå¦‚æœæ˜¯åè¿›åˆ¶æ•°ï¼Œä¹Ÿæ˜¯æœ‰ç¬¦å·çš„æ•´æ•°ã€‚

- ä¸€èˆ¬çš„æ ˆç»“æ„ï¼Œæ ˆåº•æ˜¯é«˜åœ°å€ï¼Œæ ˆé¡¶æ˜¯ä½åœ°å€ï¼Œæ•°æ®åœ¨æ ˆé¡¶è¿›å‡ºï¼Œ`%rsp`æŒ‡å‘æ ˆé¡¶ã€‚å¸¸è§çš„æ ˆç»“æ„å¦‚ä¸‹æ‰€ç¤º

 ![](https://pic.imgdb.cn/item/6278fd150947543129801e44.png)

- ç®—æœ¯æŒ‡ä»¤çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯åœ¨å¯„å­˜å™¨ä¸­è¿›è¡Œçš„ï¼Œæ¢å¥è¯è¯´ï¼Œå¦‚æœéœ€è¦å°†å†…å­˜ä¸­çš„ä¸¤ä¸ªæ•°ç›¸åŠ ï¼Œç¬¬ä¸€æ­¥æ˜¯å…ˆæŠŠå®ƒä»¬æ¬ç§»åˆ°å¯„å­˜å™¨ä¸­ï¼Œç„¶åè°ƒç”¨ADDæŒ‡ä»¤å†ç›¸åŠ ï¼Œç»“æœä¹Ÿä¼šä¿å­˜åœ¨å¯„å­˜å™¨ä¸­ã€‚

- æ ¹æ®`TEST`æŒ‡ä»¤å¯ä»¥åˆ¤æ–­ä¸€ä¸ªæ•°çš„æ­£è´Ÿæˆ–è€…é›¶ã€‚å› ä¸º`testq %rax %rax`æŒ‡ä»¤ä¸ä¼šæ”¹å˜å¯„å­˜å™¨é‡Œé¢çš„å€¼ï¼Œä½†æ˜¯ä¼šæ ¹æ®`(%rax) && (%rax) = (%rax)`çš„å€¼æ¥è®¾ç½®æ¡ä»¶ç çš„æ ‡å¿—ä½ã€‚æ¯”å¦‚ï¼Œå¯ä»¥æ ¹æ®æŒ‡ä»¤ç»“æŸä¹‹åçš„ZFçš„å€¼åˆ¤æ–­æ˜¯å¦æ˜¯0ï¼ŒSFçš„å€¼åˆ¤æ–­æ˜¯å¦æ˜¯è´Ÿæ•°ç­‰ã€‚

- æ ¹æ®ä¸Šä¸€æ¡æŒ‡ä»¤çš„cmpç»“æœè®¾ç½®æŒ‡å®šå¯„å­˜å™¨çš„å€¼ï¼Œä½¿ç”¨ä¸‹é¢çš„è¡¨æ ¼å®ç°ï¼Œæƒ³èµ·æ¥æŒºçƒ§è„‘ï¼Œäº†è§£å³å¯

  ![](https://pic.imgdb.cn/item/6279003f094754312987963d.png)

- è·³è½¬æŒ‡ä»¤çš„åº•å±‚æœºå™¨ç¼–ç ä¸­çš„è·³è½¬åœ°å€ä½¿ç”¨ç›¸å¯¹ç¼–ç çš„å½¢å¼ã€‚æ³¨æ„ï¼Œæ±‡ç¼–å™¨ç”Ÿæˆçš„`*.s`ä¸­æ˜¯æ±‡ç¼–è¯­è¨€ï¼Œé‡Œé¢è·³è½¬æŒ‡ä»¤çš„åœ°å€åç§»æ˜¯ç»å¯¹å€¼ï¼Œä½†æ˜¯é€šè¿‡é“¾æ¥å™¨æˆ–è€…åæ±‡ç¼–å¾—åˆ°çš„**äºŒè¿›åˆ¶ç¼–ç å°±æ˜¯ç”¨ç›¸å¯¹å¯»å€ç¼–ç çš„**ã€‚è¿˜æ˜¯ä¹¦é‡Œé¢çš„ä¾‹å­ã€‚æ±‡ç¼–æ–‡ä»¶å¦‚ä¸‹

  ![](https://pic.imgdb.cn/item/627902eb09475431298e2160.png)

  `*.o`åæ±‡ç¼–ä¹‹åçš„æ–‡ä»¶å¦‚ä¸‹

  ![](https://pic.imgdb.cn/item/6279031d09475431298ea166.png)

  æ³¨æ„ç¬¬2è¡Œçš„è·³è½¬æŒ‡ä»¤çš„åœ°å€äºŒè¿›åˆ¶ç¼–ç æ˜¯03ï¼Œè¿™ä¸ªæ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€çš„ç›¸å¯¹å€¼ï¼Œä¹Ÿå°±æ˜¯**è·³è½¬çš„åœ°å€ï¼ˆ8) = ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€(5) + åç§»é‡(3)**ã€‚ç¬¬5è¡Œä¹Ÿä¸€æ ·ï¼Œ5 = 0xd + f8(-8)ã€‚è¿™æ ·åšçš„å¥½å¤„ä¹‹ä¸€ï¼Œæ˜¯å¯é‡å®šä½ç›®æ ‡ç¨‹åºé€šè¿‡é“¾æ¥å™¨é“¾æ¥ä¹‹åï¼ŒæŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯**äºŒè¿›åˆ¶ç¼–ç ä¾ç„¶ä¿æŒä¸å˜**ã€‚

### å‡½æ•°è·³è½¬

## é—®é¢˜è§£ç­”

å­¦ä¹ æœ¬ç« çš„å†…å®¹ä¹‹åï¼Œåº”è¯¥å¯ä»¥å›ç­”ä¸‹é¢çš„é—®é¢˜

> ä¸ºä»€ä¹ˆswitchçš„caseå¿…é¡»æ˜¯æ•´æ•°ï¼Ÿ

---

è¿˜æ²¡å†™å®ŒğŸš€
